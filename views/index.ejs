<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>Crypto Web Application</title>

  <!-- CSS Stylesheets -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-aFq/bzH65dt+w6FI2ooMVUpc+21e0SRygnTpmBvdBgSdnuTN7QbdgL+OapgHtvPp" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="css/styles.css">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js" integrity="sha384-qKXV1j0HvMUeCBQ+QVp7JcfGl760yU08IQ+GpUo5hlbpg51QRiuqHAJz8+BrxE/N" crossorigin="anonymous"></script>
  <!-- Datatables -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <!-- Highcharts -->
  <script src="https://code.highcharts.com/stock/highstock.js"></script>
  <script src="https://code.highcharts.com/stock/modules/data.js"></script>
  <script src="https://code.highcharts.com/stock/modules/drag-panes.js"></script>
  <script src="https://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/stock/modules/accessibility.js"></script>
</head>

<body>

  <!-- User Selection -->

  <section id="user-selection">

    <div class="container-fluid">

      <nav class="navbar navbar-expand-sm navbar-light">
        <div class="navbar-nav">

          <form class="crypto-selection d-flex form-inline" action="/getCryptoInfo" method="post">
            <select class="form-select" name="cryptos" id="crypto-select">
              <% Object.keys(cryptoPairs).forEach(function(cryptoKey) { %>
                <option value="<%= cryptoKey %>" <% if (crypto.summary.price.symbol === cryptoKey) { %> selected <% } %>>
                  <%= cryptoPairs[cryptoKey] %>
                </option>
              <% }); %>
            </select>
          </form>

          <form class="d-flex form-inline ms-auto" action="/updateNewsInput" method="post">
            <div class="me-2 form-group">
              <textarea
                id="exampleFormControlTextarea1"
                class="form-control"
                data-toggle="tooltip"
                data-placement="bottom"
                title="Enter any news for price prediction"
                name="newsInput"
                rows="1" cols="30"
                placeholder="(Optional) News Input"
              ></textarea>
            </div>
            <button class="btn btn-dark" type="submit">Predict</button>
          </form>

        </div>
      </nav>

    </div>

  </section>

  <!-- Info -->

  <section id="info">

    <div class="container-fluid">

      <div class="row">

        <div class="info-box col-lg-4 col-md-6">
          <div class="card">
            <div class="card-crypto-info card-body d-flex align-items-center justify-content-center">
              <img class="card-crypto-image" src="<%= 'https://assets.coincap.io/assets/icons/' + crypto.summary.price.symbol.split('-')[0].toLowerCase() + '@2x.png' %>" alt="<%= crypto.summary.price.symbol.split('-')[0] %>">

              <h1>
                <span><%= crypto.summary.price.shortName %></span>
                <span class="card-crypto-symbol">( <%= crypto.summary.price.symbol %> )</span>
              </h1>
            </div>
          </div>
        </div>

        <div class="info-box col-lg-4 col-md-6">
          <div class="card">
            <div class="card-header align-items-center justify-content-center">
              <h4>Today Price</h4>
            </div>
            <div class="card-body text-start">
              <p><b>Today Open:</b> <%= crypto.summary.summaryDetail.regularMarketOpen %></p>
              <p><b>Today Low:</b> <%= crypto.summary.summaryDetail.regularMarketDayLow %></p>
              <p><b>Today High:</b> <%= crypto.summary.summaryDetail.regularMarketDayHigh %></p>
              <p><b>Today Volume:</b> <%= crypto.summary.summaryDetail.volume %></p>
              <p><b>Market Cap:</b> <%= crypto.summary.summaryDetail.marketCap %></p>
            </div>
          </div>
        </div>

        <div class="info-box col-lg-4">
          <div class="card">
            <div class="card-header align-items-center justify-content-center">
              <h4>Details</h4>
            </div>
            <div class="card-body text-start">
              <p><b>52 Day Low:</b> <%= crypto.summary.summaryDetail.fiftyTwoWeekLow %></p>
              <p><b>52 Day High:</b> <%= crypto.summary.summaryDetail.fiftyTwoWeekHigh %></p>
              <p><b>200 Day Average Price:</b> <%= crypto.summary.summaryDetail.twoHundredDayAverage %></p>
              <p><b>10 Day Average Volume:</b> <%= crypto.summary.summaryDetail.averageVolume10days %></p>
            </div>
          </div>
        </div>

      </div>

    </div>

  </section>

  <!-- Graphics -->

  <section id="graphics">

    <div class="container-fluid">

      <div class="row">

        <div class="graphics-column col-xl-6">
          <div class="border rounded container">
            <div id="chart"></div>
          </div>
        </div>

        <div class="graphics-column col-xl-6">
          <div class="graphics-column-table table-responsive border rounded container">
            <table id="crypto-table" class="display table table-striped caption-top">
              <caption>Historical Data</caption>
              <thead>
                <tr class="table-dark">
                  <th scope="col">Date</th>
                  <th scope="col">Open</th>
                  <th scope="col">High</th>
                  <th scope="col">Low</th>
                  <th scope="col">Close</th>
                  <th scope="col">Adj. Close</th>
                  <th scope="col">Volume</th>
                </tr>
              </thead>
              <tbody>
                <% for (const price of crypto.prices) { %>
                  <tr>
                    <th scope="row"><%= price.date %></th>
                    <td><%= price.open %></td>
                    <td><%= price.high %></td>
                    <td><%= price.low %></td>
                    <td><%= price.close %></td>
                    <td><%= price.adjClose %></td>
                    <td><%= price.volume %></td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>

      </div>

    </div>

  </section>

  <script>
  // Form Manipulation
    $(function() {
      // crypto selection form
      const form = document.querySelector('.crypto-selection');
      form.addEventListener('change', function() {
        form.submit();
      });

      // news prediction form
      $('[data-toggle="tooltip"]').tooltip({
        delay: {
          "show": 400,
          "hide": 100
        }
      })
    })
  </script>

  <script src="js/chart.js"></script>
  <script>
    // Chart Creation
    let cryptoPrices = '<%= JSON.stringify(crypto.prices) %>'
    const parser = new DOMParser();
    cryptoPrices = parser.parseFromString(`<!doctype html><body>${cryptoPrices}`, 'text/html').body.textContent;
    cryptoPrices = JSON.parse(cryptoPrices);
    cryptoName = '<%= crypto.summary.price.shortName %>';

    createChart(cryptoPrices, cryptoName);
  </script>

  <script>
  // Datatable Formatting
    $(function() {
      const formatter = DataTable.render.number(',', '.', 2, '<%= crypto.summary.price.currencySymbol %>');
      $("#crypto-table").DataTable({
        searching: false,
        order: [
          [0, "desc"]
        ],
        columns: [{
            render: (data, type) => {
              if (type == "display") {
                return new Date(data).toLocaleDateString("en-US", "short");
              }
              return data;
            }
          },
          { render: formatter },
          { render: formatter },
          { render: formatter },
          { render: formatter },
          { render: formatter },
          {}
        ],
        // scrollY: '50vh',
        // scrollCollapse: true,
        paging: true,
        // scrollX: true,
        initComplete: () => $(".table-responsive").show()
      });
      jQuery('#crypto-table').wrap('<div class="dataTables_scroll" />');
    })
  </script>

</body>

</html>
